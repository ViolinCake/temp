pipeline {
  agent {
    kubernetes {
      yamlFile 'testing/kaniko-builder.yaml'
    }
  }

  environment {
    APP_NAME   = "complete-prodcution-e2e-pipeline"
    RELEASE    = "1.0.0"
    IMAGE_TAG  = "${RELEASE}-${BUILD_NUMBER}"
  }

  stages {

    stage("Cleanup Workspace") {
      steps {
        cleanWs()
      }
    }

    stage("Checkout from SCM") {
      steps {
        git branch: 'main', credentialsId: 'github', url: 'https://github.com/ViolinCake/temp'
      }
    }
    
    // ðŸ‘† REMOVE THIS AFTER DEBUGGING
        stage('Build & Push with Kaniko') {
            environment {
                DOCKER_CREDS = credentials('dockerhub') // Securely fetch DockerHub creds
        }
      steps {
        container(name: 'kaniko', shell: '/busybox/sh') {
          sh '''#!/busybox/sh
            echo "Preparing Docker config for Kaniko..."

            mkdir -p /kaniko/.docker

            # --- CRITICAL FIX: Add -w 0 to base64 to prevent newlines in the JSON string ---
            AUTH_STRING=$(echo -n ${DOCKER_CREDS_USR}:${DOCKER_CREDS_PSW} | base64 -w 0)

            echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"${AUTH_STRING}\"}}}" > /kaniko/.docker/config.json

            echo "Building and pushing image with Kaniko..."
            /kaniko/executor \\
              --dockerfile `pwd`/testing/Dockerfile \\
              --context `pwd`/testing \\
              --destination=${DOCKER_CREDS_USR}/${APP_NAME}:${IMAGE_TAG} \\
              --destination=${DOCKER_CREDS_USR}/${APP_NAME}:latest
          '''
        }
      }
    }
    // ðŸ‘‡ ADD THIS TEMPORARY DEBUG STEP
    stage("DEBUG PAUSE") {
        steps {
            
            input(message: 'Pod is frozen. Go check kubectl describe now!', submitter: 'admin')
        }
    }
  }
}
