pipeline {
  agent {
    kubernetes {
      yamlFile 'testing/kaniko-builder.yaml'
    }
  }

  environment {
    APP_NAME   = "complete-prodcution-e2e-pipeline"
    RELEASE    = "1.0.0"
    IMAGE_TAG  = "${RELEASE}-${BUILD_NUMBER}"
  }

  stages {

    stage("Cleanup Workspace") {
      steps {
        cleanWs()
      }
    }

    stage("Checkout from SCM") {
      steps {
        git branch: 'main', credentialsId: 'github', url: 'https://github.com/ViolinCake/temp'
      }
    }

    stage('Build & Push with Kaniko') {
      environment {
        DOCKER_CREDS = credentials('dockerhub') // ðŸ‘ˆ Securely fetch DockerHub creds
      }
      steps {
        container(name: 'kaniko', shell: '/busybox/sh') {
          sh '''#!/busybox/sh
            echo "Preparing Docker config for Kaniko..."

            mkdir -p /kaniko/.docker
            echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(echo -n ${DOCKER_CREDS_USR}:${DOCKER_CREDS_PSW} | base64)\"}}}" > /kaniko/.docker/config.json

            echo "Building and pushing image with Kaniko..."
            /kaniko/executor \
              --dockerfile `pwd`/testing/Dockerfile \
              --context `pwd`/testing \
              --destination=${DOCKER_CREDS_USR}/${APP_NAME}:${IMAGE_TAG} \
              --destination=${DOCKER_CREDS_USR}/${APP_NAME}:latest
          '''
        }
      }
    }
  }
}
